function PriceStr(a){return(new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2})).format(a)}
function UpdateCompound(){var a=Number(document.getElementById("comp_starting").value),b=Number(document.getElementById("comp_contrib").value),c=Number(document.getElementById("comp_rate").value),d=Number(document.getElementById("comp_years").value);c=c/100/12;d*=12;a=a*Math.pow(1+c,d)+b*(Math.pow(1+c,d)-1)/c;b*=d;d=a-b;document.getElementById("comp_principal").textContent=PriceStr(b);document.getElementById("comp_interest").textContent=PriceStr(d);document.getElementById("comp_ending").textContent=
PriceStr(a)}var g_nMkt=7800,g_iMkt=0,g_aMkt=[0],g_bnk=0,g_mkt=0,g_avg=0,g_principal=0,g_uid=0,g_mktInterval=0;function BuySell(a){.5>=g_bnk-a?(g_mkt+=g_bnk/g_aMkt[g_iMkt],g_bnk=0):.5>=g_mkt*g_aMkt[g_iMkt]+a?(g_bnk+=g_mkt*g_aMkt[g_iMkt],g_mkt=0):(g_bnk-=a,g_mkt+=a/g_aMkt[g_iMkt]);PaintMarket()}function Buy(a){BuySell(void 0===a?1E3:a)}function BuyAll(){BuySell(g_bnk)}function Sell(a){BuySell(-(void 0===a?1E3:a))}function SellAll(){BuySell(-(g_mkt*g_aMkt[g_iMkt]))}
function MktMoneyStr(a){return(new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0})).format(a)}function MktGainStr(a){return(new Intl.NumberFormat("en-US",{style:"percent",signDisplay:"exceptZero",minimumFractionDigits:100>a?1:0,maximumFractionDigits:100>a?1:0})).format(a)}
function PaintMarket(){document.getElementById("youBnk").textContent=MktMoneyStr(g_bnk);document.getElementById("youMkt").textContent=MktMoneyStr(g_mkt*g_aMkt[g_iMkt]);document.getElementById("youTtl").textContent=MktMoneyStr(g_bnk+g_mkt*g_aMkt[g_iMkt]);document.getElementById("avgMkt").textContent=document.getElementById("avgTtl").textContent=MktMoneyStr(g_avg*g_aMkt[g_iMkt]);document.getElementById("mktPrincipal").textContent=MktMoneyStr(g_principal);var a=0,b=0;0<g_principal&&(a=(g_bnk+g_mkt*g_aMkt[g_iMkt]-
g_principal)/g_principal,b=(g_avg*g_aMkt[g_iMkt]-g_principal)/g_principal);document.getElementById("youGain").textContent=MktGainStr(a);document.getElementById("youGain").style="color:"+(0<a?"lime":"red");document.getElementById("avgGain").textContent=MktGainStr(b);document.getElementById("avgGain").style="color:"+(0<b?"lime":"red");document.getElementById("buy").disabled=document.getElementById("buyall").disabled=0>=g_bnk;document.getElementById("sell").disabled=document.getElementById("sellall").disabled=
0>=g_mkt;a=Math.floor(g_iMkt/260);b=Math.floor(g_iMkt%260/(260/12));document.getElementById("mktElapsed").textContent=a+" years, "+b+" months";a=document.getElementById("mktGraph");b=a.getContext("2d");b.clearRect(0,0,a.width,a.height);var c=document.querySelector("input[name=zoom]:checked");c=c?Number(c.value):1;for(var d=g_iMkt>a.width/c?g_iMkt-a.width/c:0,f=a.height/2,g=g_aMkt[d],h=Math.abs(.2*g),e=d+1;e<g_iMkt;e++)h=Math.max(h,Math.abs(g_aMkt[e]-g));h=-(f-10)/h;b.strokeStyle="LightGrey";b.beginPath();
for(e=0;e<a.width;e++)0==Math.floor((d*c+e)%(260/12*c))&&(b.moveTo(e,0),b.lineTo(e,a.height));b.stroke();b.strokeStyle="Grey";b.beginPath();b.moveTo(0,f);b.lineTo(a.width,f);b.stroke();e=(g_aMkt[g_iMkt]-g)*h+f;b.strokeStyle="Yellow";b.beginPath();b.moveTo(0,e);b.lineTo(a.width,e);b.stroke();e=0;b.strokeStyle="Blue";b.beginPath();for(b.moveTo(-1,a.height/2);d<=g_iMkt;)b.lineTo(e++*c,(g_aMkt[d++]-g)*h+f);b.stroke()}
function SendMarketScore(){var a=0,b=0;0<g_principal&&(a=(g_bnk+g_mkt*g_aMkt[g_iMkt]-g_principal)/g_principal,b=(g_avg*g_aMkt[g_iMkt]-g_principal)/g_principal);var c=new XMLHttpRequest,d=new FormData;d.set("uid",g_uid);d.set("day",g_iMkt);d.set("youCash",Math.round(g_bnk+g_mkt*g_aMkt[g_iMkt]));d.set("avgCash",Math.round(g_avg*g_aMkt[g_iMkt]));d.set("youGain",(100*a).toFixed(1));d.set("avgGain",(100*b).toFixed(1));c.open("POST","/invest/marketgame.php");c.send(d)}
function UpdateMarket(){g_iMkt+1>=g_aMkt.length?(clearInterval(g_mktInterval),SendMarketScore(),PaintMarket(),document.getElementById("mktElapsed").textContent="30 years, game over.",document.getElementById("mktStart").textContent="Play Again",document.getElementById("mktOverlay").style.display="",FetchMarketScores(),InitMarket()):(g_iMkt++,0==Math.trunc(g_iMkt%(260/12))&&(g_principal+=1E3,g_bnk+=1E3,g_avg+=1E3/g_aMkt[g_iMkt],SendMarketScore()),PaintMarket())}
function StartMarket(){if(g_aMkt&&g_aMkt.length){document.getElementById("mktOverlay").style.display="none";document.getElementById("mktName").textContent=document.getElementById("mktName").value||"You";document.querySelectorAll("#market input[type=radio]").forEach(function(c){return c.disabled=!1});g_iMkt=g_aMkt.length-50;g_bnk=g_mkt=g_avg=g_principal=0;g_mktInterval=setInterval(UpdateMarket,200);var a=new XMLHttpRequest,b=new FormData;b.set("uid",g_uid);b.set("name",document.getElementById("mktName").value);
a.open("POST","/invest/marketgame.php");a.send(b)}else document.getElementById("mktOverlay").innerHTML='<span class="mktError">No market data.</span>'}
function InitMarket(){document.querySelectorAll("#market button").forEach(function(c){return c.disabled="mktStart"!=c.id});document.querySelectorAll("#market input[type=radio]").forEach(function(c){return c.disabled=!0});var a=new XMLHttpRequest,b=new FormData;b.set("Market","");a.responseText="json";a.onload=function(){if(200==this.status)try{console.log(this.response.substring(0,100));var c=JSON.parse(this.response);g_uid=c.uid;g_aMkt=c.aMkt.map(function(d){return parseFloat(d)})}catch(d){g_uid=
0,g_aMkt=[0]}g_aMkt&&g_aMkt.length&&g_uid||(document.getElementById("mktOverlay").innerHTML='<span class="mktError">Error loading market data.</span>')};a.open("POST","/invest/marketgame.php");a.send(b)}
function ShowScores(a){var b=document.querySelector("#mktScores tbody");b.querySelectorAll("tr").forEach(function(c){return c.remove()});a.forEach(function(c){var d=b.insertRow();c.forEach(function(f){var g=d.insertCell(),h=document.createTextNode(f);g.appendChild(h);"+"==f[0]&&g.classList.add("pos");"-"==f[0]&&g.classList.add("neg")})})}
function FetchMarketScores(){var a=new XMLHttpRequest,b=new FormData;b.set("scores","");a.responseText="json";a.onload=function(){ShowScores(JSON.parse(a.response))};a.open("POST","/invest/marketgame.php");a.send(b)}window.addEventListener("load",function(){document.querySelectorAll("#compound input").forEach(function(a){a.addEventListener("input",UpdateCompound)});UpdateCompound();InitMarket();PaintMarket();FetchMarketScores()});
